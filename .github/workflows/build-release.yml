name: Build and Release

on:
  workflow_dispatch:
  push:
    branches: [ "master" ]
    tags: [ "v*" ]

jobs:
  build:
    runs-on: windows-latest
    
    permissions:
      contents: write 

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore PCL_CE_Patcher.csproj

    # =========================================================
    # 步骤 1：根据触发类型设置变量 (控制 PDB)
    # =========================================================
    - name: Set Build Options
      id: options
      shell: pwsh
      run: |
        if ("${{ github.ref }}".StartsWith("refs/tags/")) {
          echo "IS_RELEASE=true" >> $env:GITHUB_ENV
          # Release: 无调试符号，极致瘦身
          echo "BUILD_ARGS=-p:DebugType=None -p:DebugSymbols=false" >> $env:GITHUB_ENV
        } else {
          echo "IS_RELEASE=false" >> $env:GITHUB_ENV
          # CI: 保留调试符号，方便查错
          echo "BUILD_ARGS=-p:DebugType=portable -p:DebugSymbols=true" >> $env:GITHUB_ENV
        }

    # =========================================================
    # 步骤 2：编译 (全靠参数控制)
    # =========================================================
    - name: Publish Patcher
      run: |
        dotnet publish PCL_CE_Patcher.csproj -c Release -r win-x64 `
        --no-self-contained `
        -p:PublishSingleFile=true `
        -p:IncludeNativeLibrariesForSelfExtract=true `
        ${{ env.BUILD_ARGS }} `
        -o ./output

    # =========================================================
    # 步骤 3：准备文件
    # =========================================================
    - name: Prepare Assets
      run: |
        copy LICENSE ./output/
        copy ThirdPartyNotices.txt ./output/

    # =========================================================
    # 步骤 4：打包与上传
    # =========================================================
    
    # 场景 A: 正式发布 (Tag) -> 手动打 Zip
    - name: Zip for Release
      if: env.IS_RELEASE == 'true'
      run: |
        powershell Compress-Archive -Path ./output/* -DestinationPath PCL_CE_Patcher.zip

    # 场景 B: CI 测试 (Push) -> 上传文件夹 (Action会自动压成zip)
    - name: Upload CI Artifact
      if: env.IS_RELEASE == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: PCL_CE_Patcher_CI_Build
        path: ./output/*
        retention-days: 7

    # 场景 A: 正式发布 -> 上传 Release 附件备用
    - name: Upload Release Artifact
      if: env.IS_RELEASE == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: PCL_CE_Patcher_Release_Pkg
        path: PCL_CE_Patcher.zip
        retention-days: 90

    # =========================================================
    # 步骤 5：发布到 GitHub Releases (仅 Tag)
    # =========================================================
    - name: Upload to Release Page
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: PCL_CE_Patcher.zip